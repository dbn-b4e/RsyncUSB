#!/bin/bash

# Help
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: syncwork [SOURCE_FOLDER]"
    echo ""
    echo "Sync a folder to an external USB drive using rsync."
    echo ""
    echo "Arguments:"
    echo "  SOURCE_FOLDER    Folder to sync (default: ~/Work)"
    echo ""
    echo "Options:"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Excludes: .DS_Store, @eaDir, .SynologyWorkingDirectory"
    exit 0
fi

# Source folder: first argument or ~/Work
SOURCE="${1:-$HOME/Work}"

if [ ! -d "$SOURCE" ]; then
    echo "Source folder not found: $SOURCE"
    exit 1
fi

# Find external volumes (exclude system volumes)
VOLUMES=$(ls /Volumes/ | grep -v "Macintosh HD" | grep -v "com.apple" | grep -v "Sauvegardes")

if [ -z "$VOLUMES" ]; then
    echo "No external disks found!"
    exit 1
fi

echo "Available external disks:"
echo ""
i=1
declare -a DISK_ARRAY
while IFS= read -r disk; do
    DISK_ARRAY[$i]="$disk"
    echo "  $i) $disk"
    ((i++))
done <<< "$VOLUMES"

echo ""
read -p "Select disk number [1]: " choice
choice=${choice:-1}

SELECTED="${DISK_ARRAY[$choice]}"

if [ -z "$SELECTED" ]; then
    echo "Invalid selection!"
    exit 1
fi

echo ""
echo "Syncing $SOURCE to /Volumes/$SELECTED/ ..."
echo ""

/usr/local/bin/rsync -avh --info=progress2 \
    --exclude='.SynologyWorkingDirectory' \
    --exclude='@eaDir' \
    --exclude='.DS_Store' \
    "$SOURCE" "/Volumes/$SELECTED"
